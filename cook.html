<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Food Suggestions – Based on Your Calendar</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --brand:#22c55e; --accent:#38bdf8; --danger:#ef4444; --card:#0b1220; --ring:#334155;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg,#020617,#0f172a 45%,#020617);
      color:var(--text);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    .container{max-width:900px;margin:24px auto;padding:16px}
    .app{
      background:var(--panel);
      border:1px solid var(--ring);
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 20px 40px rgba(2,6,23,.6);
    }
    header{
      padding:16px 18px;
      border-bottom:1px solid var(--ring);
      background:linear-gradient(180deg,#020617,#020617 45%,#0b1220);
    }
    header h1{margin:0;font-size:20px;font-weight:700}
    .sub{font-size:13px;color:var(--muted);margin-top:4px}
    main{padding:16px 18px 20px 18px;display:flex;flex-direction:column;gap:18px}

    .card{
      background:var(--card);
      border:1px solid var(--ring);
      border-radius:14px;
      padding:12px 14px;
    }
    .card h2{margin:0 0 6px 0;font-size:16px}
    .card h3{margin:0 0 6px 0;font-size:15px}

    .pill-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
    .pill{
      border-radius:999px;
      border:1px solid var(--ring);
      padding:4px 8px;
      font-size:12px;
      color:#e5e7eb;
    }
    .pill.bad{border-color:var(--danger);color:#fecaca}
    .pill.good{border-color:var(--brand);color:#bbf7d0}

    .diet-list{margin-top:6px;font-size:13px;color:var(--muted)}
    .diet-item{margin-bottom:4px}

    .recipes{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px}
    @media (min-width:720px){
      .recipes{grid-template-columns:1fr 1fr;}
    }
    .recipe-title{font-size:14px;font-weight:600;margin-bottom:2px}
    .macros{display:flex;flex-wrap:wrap;gap:4px;margin:4px 0}
    .macros .pill{font-size:11px;padding:3px 7px}
    .reason{font-size:12px;color:var(--muted);margin-bottom:6px}
    .btn-link{
      display:inline-block;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--accent);
      color:#e0f2fe;
      text-decoration:none;
      margin-top:4px;
    }
    .btn-link:hover{background:#0f172a;}

    .footer-note{font-size:12px;color:var(--muted);margin-top:4px}
  </style>
</head>
<body>
  <div class="container">
    <div class="app">
      <header>
        <h1>Food Suggestions</h1>
        <div class="sub">
          Uses your <strong>Health Calendar</strong> diet records (last 6 days) to suggest a healthy, lower-calorie home-cooked meal for today.
        </div>
      </header>

      <main>
        <!-- Summary of recent diet -->
        <section class="card" id="summaryCard">
          <h2>Your recent eating pattern (last 6 days)</h2>
          <div id="summaryText" class="sub">Loading from calendar data…</div>
          <div class="pill-row" id="statPills"></div>
          <div class="diet-list" id="dietHistory"></div>
        </section>

        <!-- Suggestions for today -->
        <section class="card">
          <h2>Today's home-cooking suggestions</h2>
          <div id="suggestionIntro" class="sub">
            We will suggest meals that balance nutrition and keep calories on the lower side.
          </div>
          <div class="recipes" id="recipeList"></div>
          <div class="footer-note">
            Tip: Write down what you actually cook in the calendar so tomorrow’s suggestion becomes smarter.
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    // ===== Shared storage key with the Health Calendar =====
    const STORE_KEY = 'healthCalendarData.v1';

    function loadCalendarData(){
      try{
        return JSON.parse(localStorage.getItem(STORE_KEY)) || {};
      }catch{
        return {};
      }
    }

    // ===== Diet history analysis =====
    function getRecentDietEntries(data, limitDays){
      const today = new Date();
      today.setHours(0,0,0,0);
      const keys = Object.keys(data || {})
        .filter(k => data[k] && data[k].diet && data[k].diet.trim())
        .sort((a,b) => new Date(b) - new Date(a)); // newest first

      const result = [];
      for(const k of keys){
        const d = new Date(k);
        if(d > today) continue; // ignore future dates
        result.push({ date: k, text: data[k].diet.trim() });
        if(result.length >= limitDays) break;
      }
      return result;
    }

    function analyzeDietHistory(entries){
      const stats = {veg:0, fruit:0, fried:0, sugary:0, whole:0, lean:0, red:0};
      const hasAny = (text, words) => words.some(w => text.includes(w));

      entries.forEach(e => {
        const t = e.text.toLowerCase();
        if(hasAny(t,['salad','broccoli','spinach','vegetable','veggie','kale','cabbage','lettuce','green bean','carrot'])) stats.veg++;
        if(hasAny(t,['apple','banana','berry','grape','orange','fruit','pear','peach'])) stats.fruit++;
        if(hasAny(t,['fried','fries','deep-fried','tempura'])) stats.fried++;
        if(hasAny(t,['cake','cookie','dessert','ice cream','candy','soda','sweet','donut','doughnut'])) stats.sugary++;
        if(hasAny(t,['brown rice','quinoa','oat','oatmeal','whole wheat','whole-wheat','whole grain','whole-grain'])) stats.whole++;
        if(hasAny(t,['chicken breast','chicken','turkey','fish','salmon','tuna','shrimp'])) stats.lean++;
        if(hasAny(t,['beef','pork','steak','burger','bacon'])) stats.red++;
      });
      return stats;
    }

    // ===== Recipe data (home cooking only) =====
    const recipes = [
      {
        name:'One-pan salmon with roasted vegetables',
        kcal:520, carb:45, fat:18, protein:38,
        meta:{veg:true, whole:true, lean:true, fried:false, lowSugar:true},
        url:'https://www.youtube.com/watch?v=k5MEgoCYNAc'
      },
      {
        name:'Chicken & vegetable stir-fry with rice',
        kcal:480, carb:40, fat:12, protein:45,
        meta:{veg:true, whole:false, lean:true, fried:false, lowSugar:true},
        url:'https://www.youtube.com/watch?v=h6EaCv-lLQY'
      },
      {
        name:'Whole-wheat pasta with tomato & turkey sauce',
        kcal:610, carb:70, fat:14, protein:35,
        meta:{veg:true, whole:true, lean:true, fried:false, lowSugar:true},
        url:'https://www.youtube.com/watch?v=Q8qVoMmpCpA'
      },
      {
        name:'Tofu & broccoli stir-fry (vegetarian)',
        kcal:450, carb:35, fat:14, protein:32,
        meta:{veg:true, whole:false, lean:false, fried:false, lowSugar:true},
        url:'https://www.youtube.com/watch?v=IpvwUAu2rKE'
      },
      {
        name:'Tuna & avocado salad + whole-grain toast',
        kcal:520, carb:42, fat:18, protein:36,
        meta:{veg:true, whole:true, lean:true, fried:false, lowSugar:true},
        url:'https://www.youtube.com/watch?v=BMYzSFeJHxc'
      }
    ];

    function scoreRecipe(recipe, stats, entryCount){
      // base preference: lower calories are better
      let s = 0;
      if(recipe.kcal <= 550) s += 1;
      if(recipe.kcal >= 700) s -= 1;

      if(entryCount > 0){
        // If you did not eat much vegetables, prefer veg recipes
        if(stats.veg < 3 && recipe.meta.veg) s += 2;
        // If whole grains are low, prefer whole-grain recipes
        if(stats.whole < 2 && recipe.meta.whole) s += 1;
        // If you ate fried food before, prefer non-fried recipes
        if(stats.fried > 0 && recipe.meta.fried === false) s += 1;
        // If red meat was high, prefer lean protein
        if(stats.red > 2 && recipe.meta.lean) s += 1;
        // If sugary foods were high, prefer low-sugar recipes
        if(stats.sugary > 1 && recipe.meta.lowSugar) s += 1;
      }
      return s;
    }

    // ===== Rendering helpers =====
    function renderSummary(entries, stats){
      const summaryText = document.getElementById('summaryText');
      const pills = document.getElementById('statPills');
      const history = document.getElementById('dietHistory');

      pills.innerHTML = '';
      history.innerHTML = '';

      if(entries.length === 0){
        summaryText.textContent =
          'We did not find any diet records in your Health Calendar. Please record your meals for a few days so we can give more personal suggestions.';
        return;
      }

      const n = entries.length;
      if(n < 6){
        summaryText.textContent =
          `We found ${n} day(s) of diet records. Suggestions will be general but still healthy and lower-calorie.`;
      }else{
        summaryText.textContent =
          `We used your last 6 days of diet records to understand your eating pattern.`;
      }

      function addPill(text, type){
        const span = document.createElement('span');
        span.className = 'pill' + (type ? ' ' + type : '');
        span.textContent = text;
        pills.appendChild(span);
      }

      // Simple interpretation
      if(stats.veg === 0) addPill('Very low vegetables', 'bad');
      else if(stats.veg <= 2) addPill('Could eat more vegetables', 'bad');
      else addPill('Vegetables ok', 'good');

      if(stats.whole === 0) addPill('No whole grains', 'bad');
      else if(stats.whole <= 2) addPill('Some whole grains', 'good');
      else addPill('Good whole-grain intake', 'good');

      if(stats.fried > 0) addPill('Fried food recently', 'bad');
      if(stats.sugary > 1) addPill('Sweet desserts / sugary drinks', 'bad');
      if(stats.red > 2) addPill('Red meat often', 'bad');
      if(stats.lean > 0) addPill('Lean protein present', 'good');

      // Show raw diet lines
      entries.forEach(e => {
        const div = document.createElement('div');
        div.className = 'diet-item';
        div.textContent = `${e.date}: ${e.text}`;
        history.appendChild(div);
      });
    }

    function renderSuggestions(entries, stats){
      const list = document.getElementById('recipeList');
      const intro = document.getElementById('suggestionIntro');
      list.innerHTML = '';

      const count = entries.length;
      let numSuggestions;

      if(count === 0){
        intro.textContent =
          'No previous diet records found. Here are some generally healthy, lower-calorie home-cooked meal ideas:';
        numSuggestions = 3;
      }else if(count < 6){
        intro.textContent =
          `Only ${count} day(s) of diet recorded. Here are a few healthy options you can choose from today:`;
        numSuggestions = 4;
      }else{
        intro.textContent =
          'Based on your last 6 days of diet, we suggest the following meals for today:';
        numSuggestions = 2;
      }

      const scored = recipes.map(r => ({
        recipe: r,
        score: scoreRecipe(r, stats, count)
      }));
      scored.sort((a,b) => b.score - a.score);
      const top = scored.slice(0, numSuggestions);

      top.forEach(({recipe}) => {
        const card = document.createElement('div');
        card.className = 'card';

        const reasons = [];
        if(recipe.meta.veg) reasons.push('adds vegetables');
        if(recipe.meta.whole) reasons.push('uses whole grains');
        if(recipe.meta.lean) reasons.push('uses lean protein');
        if(recipe.kcal <= 550) reasons.push('keeps calories moderate');
        if(recipe.meta.lowSugar) reasons.push('keeps sugar lower');

        const reasonText = reasons.length
          ? 'Reason: ' + reasons.join(', ') + '.'
          : '';

        card.innerHTML = `
          <div class="recipe-title">${recipe.name}</div>
          ${reasonText ? `<div class="reason">${reasonText}</div>` : ''}
          <div class="macros">
            <span class="pill">${recipe.kcal} kcal</span>
            <span class="pill">Carbs ${recipe.carb} g</span>
            <span class="pill">Fat ${recipe.fat} g</span>
            <span class="pill">Protein ${recipe.protein} g</span>
          </div>
        `;

        if(recipe.url){
          const a = document.createElement('a');
          a.href = recipe.url;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.className = 'btn-link';
          a.textContent = 'View recipe / video';
          card.appendChild(a);
        }

        list.appendChild(card);
      });
    }

    // ===== Init =====
    (function init(){
      const data = loadCalendarData();
      const entries = getRecentDietEntries(data, 6);
      const stats = analyzeDietHistory(entries);
      renderSummary(entries, stats);
      renderSuggestions(entries, stats);
    })();
  </script>
</body>
</html>
